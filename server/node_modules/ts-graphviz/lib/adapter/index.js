import { createWriteStream } from 'node:fs';
import { pipeline as pipeline$1, Readable } from 'node:stream';
import { promisify } from 'node:util';
import { spawn } from 'node:child_process';

/**
 * @module ts-graphviz/adapter
 * @beta
 */
function commandBuilder({ dotCommand = 'dot', suppressWarnings = true, format = 'svg' } = {}) {
  const args = [
    ...(function* () {
      if (suppressWarnings) yield '-q';
      yield `-T${format}`;
    })(),
  ];
  return [dotCommand, args];
}
/**
 * NOTE:
 * The node:stream/promises standard module is not provided in Node 14.
 * Fix Node 14 to use node:stream/promises after LTS ends.
 */
const pipeline = promisify(pipeline$1);
/**
 * Execute the Graphviz dot command and make a Stream of the results.
 */
async function toStream(dot, options) {
  const [command, args] = commandBuilder(options);
  const p = spawn(command, args, { stdio: 'pipe' });
  await pipeline(Readable.from([dot]), p.stdin);
  return p.stdout;
}
/**
 * Execute the Graphviz dot command and output the results to a file.
 */
async function toFile(dot, path, options) {
  const stream = await toStream(dot, options);
  await pipeline(stream, createWriteStream(path));
}

export { toFile, toStream };
